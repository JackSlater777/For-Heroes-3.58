ZVSE2

** Author orig.  : Algor
** Name          : Use of the scrolls and banners
** Name rus.     : Использование свитков и знамён
** Options       : 796
** Dialogs       : -
** Variables     : -
** Tmp variables : z1-z2
** Timers        : TM2(standard)
** Functions     : FU7896,FU7929-FU7931
** PO-values     : -


*?FU(OnEveryDay)&i^timerDay^>1; [в начале днЯ]
*!UN:P796/?y1;                [проверЯем включена ли опциЯ 796 в y1]
*!OW:I-1/?y2;                 [y2=1 если €€, y2=0 если человек]
*!FU|y1=0/y2=0:E;             [выход если опциЯ не включена или если ходит человек]

*!OW:H-1/1/0;                 [v1 - количество героев текущего игрока]
*!VRy3:Sv1;                   [y3 - количество героев текущего игрока]
*!DO7929/1/y3/1&y3>0:P;       [вызов FU7929 длЯ каждого героЯ текущего игрока]

*?FU7929;                     [ђазрушение свитков и знамЮн - AI проверка необходимости разрушениЯ]
*!OW:H-1/1/x16;               [v1=номер героЯ]
*!VRy3:Sv1;                   [y3=номер героЯ]
*!HEy3:I?y1;                  [y1 - мана героЯ]
*!VRy1:*5;                    [y1 - порог маны при котором разрушать свиток 1/5=20%]
*!FU(WOG_Hero_GetFullSpellPoints):Py3/?y2; [y2 - макс. мана героЯ]
*!DO7930/19/82/1&y2>y1:P1/y3; [если маны у героЯ меньше 20%, ищем в рюкзаке (слоты 19-82) свиток (x1=1) длЯ уничтожениЯ]
*!HEy3:Y65/?y1/d/d;           [проверЯем наличие бонуса скорости в y1]
*!DO7930/19/82/1&y1<500:P2/y3;[если бонус скорости меньше 500, ищем в рюкзаке (слоты 19-82) знамЯ (x1=2) длЯ уничтожениЯ]
*!HEy3:E?i/?y1;               [y1 - уровень героЯ]
*!DO7930/19/82/1&y1<15:P3/y3; [если уровень героЯ меньше 15, в рюкзаке (слоты 19-82) артефакт (x1=3) длЯ уничтожениЯ]

*?FU7930;                     [AI поиск и разрушение свитка/знамени]
** x1=1 - разрушить свиток, x1=2 - разрушить знамЯ, x2 - номер героЯ, x16 - номер слота (рюкзака)
*!HEx2:A1/?y1/x16;            [y1 - номер артефакта в слоте]
*!UN:J2/?y11;                 [y11 - выбранный человеком уровень сложности]
*!VRy11&y11=0:S80;            [y11 - бонус к эффективности пожертвований, равен бонусу уровнЯ сложности]
*!VRy11&y11=1:S100;           [...]
*!VRy11&y11=2:S130;           [...]
*!VRy11&y11=3:S160;           [...]
*!VRy11&y11=4:S200;           [...]

*!if&x1=1/y1>1000;
  *!VRy2:Sy1-1001;            [y2 - номер заклинания на свитке]
  *!SSy2:L?y10;               [получаем уровень заклинания в y10]
  *!VRy2:Sy10 *1 *y11 :100;   [бонус маны в y2 как 1*уровень заклинаниЯ + бонус за уровень сложности]
  *!HEx2:I?y3/1;              [Получение текущей маны в y3]
  *!VRy3:+y2;                 [увеличение текущей маны на y2]
  *!FU(WOG_Hero_GetFullSpellPoints):Px2/?y4; [y4 - макс. мана героЯ]
  *!VRy3&y3>y4:Sy4;           [новое значение маны не может превышать максимум маны героЯ]
  *!HEx2:Iy3/1;               [Установка нового значениЯ маны]
  *!HEx2:A3/y1/1/0;           [Удаление свитка из слота]
  *!VRx16:+64;                [переход на конец цикла]
*!en;

*!if&x1=2/y1=156; 
  *!VRy12:S500 *y11 :100;     [бонус движениЯ с учетом уровнЯ сложности]
  *!VRy13:S3 *y11 :100;       [длительность бонуса с учетом уровнЯ сложности]
  *!HEx2:Y65/y12/y13/1;       [„обавление очков передвижениЯ за подаренное знамЯ]
  *!HEx2:A3/156/1/0;          [“даление знамени из слота рюкзака]
  *!VRx16:+64;                [переход на конец цикла]
*!en; 

*!if&x1=3/y1<>156/y1>0/y1<1000;
  *!UN:Ay1/3/?y4 Ay1/5/?y5;   [y4 - класс артефакта (2/4/8/16), y5 - часть сборника (-1 = нет)]
  *!FU|y4<2/y4>4/y5<>-1:E;    [пропуск "ценных" артефактов или частей борников]
  *!FU&y1>=146/y1<=156:E;     [пропуск командирских артефактов и знамен]
  *!FU&y1>=161/y1<=170:E;     [пропуск "пустых" артефактов]
  *!VRy2&y4=2:S500;           [y2 - базовое кол-во опыта, получаемое в зависимости от класса артефакта (50% от опыта за пожертвование на алтаре)]
  
  *!VRy2&y4=4:S750;           [...]
  *!VRy2&y4=8:S1500;          [...]
  *!VRy2&y4=16:S3000;         [...]
  *!HEx2:S21/?y3;             [уровень навыка "Ћбучение" героЯ]
  *!VRy3:*5 +100;             [y3 = 100/105/110/115% - коэффициент полученного опыта]
  *!VRy2:*y3 :100 *y11 :100;  [y2 - опыт получаемый с учетом ЋбучениЯ и уровнЯ сложности]
  *!HEx2:Edy2;                [„обавление y2 очков опыта герою]
  *!HEx2:A3/y1/1/0;           [“даление артефакта из слота рюкзака]
  *!VRx16:+64;                [переход на конец цикла]
*!en;

!?FU(OnHeroGainLevel);
!!UN:P796/?y1;                [проверЯем включена ли опциЯ 796 в y1]
!!FU&y1=0:E;                  [выход если опциЯ не включена]
!!VRi^es_796_during_hero_screen^:S(TRUE);

!?FU(OnAfterHeroGainLevel)&i^es_796_during_hero_screen^;
!!VRi^es_796_during_hero_screen^:S(FALSE);

!?FU(OnHeroScreenMouseClick)&i^mouse_action^=(MOUSE_LMB_PRESSED)/i^key_ctrl^/i^es_796_during_hero_screen^=(FALSE); [по правому клику в окне героЯ]
!!UN:P796/?y1;                [проверЯем включена ли опциЯ 796 в y1]
!!FU&y1=0:E;                  [выход если опциЯ не включена]

!!CM:I?y1;                    [y1=место клика]
!!FU&y1<>11/y1<>12/y1<>13/y1<>14/y1<>20/y1<>40/y1<>41/y1<>42/y1<>43/y1<>44:E; [выход если клик не на рюкзаке или разном]

!!VRy2|y1=11/y1=12/y1=13/y1=14/y1=20:Sy1 -2; [y2=позициЯ разное длЯ HE:A]
!!VRy2&y1>=40/y1<=44:Sy1 -21; [y2=позициЯ рюкзака длЯ HE:A]
!!HE(CURRENT_HERO):A1/?y3/y2; [получаем в y3 номер артефакта в слоте]
!!VRy4&y3>1000:Sy3 -1001;     [получаем в y4 номер заклинания в свитке]
!!FU7931&y3>1000:P1/y4/y1/y2; [длЯ свитка вызываем FU7931 1/#заклинаниЯ/место клика]
!!FU7931&y3=156:P2/0/y1/y2;   [длЯ знамени вызываем FU7931 2/0/место клика]
!!FU7931&y3>0/y3<1000/y3<>156/y1>=40/y1<=44:P3/y3/y1/y2; [длЯ артефакта вызываем FU7931 2/0/место клика]

!?FU7931;                     [Разрушение свитков и знамён в слоте рюкзака по правому клику (диалог)]
** x1=1(свиток)/2(знамЯ)/3(артефакт), x2=#заклинаниЯ (свиток)/0 (знамЯ)/#артефакта (артефакт), x3=место клика, x4-слот "разное"
!#VA(itemType:x) (itemSubType:x) (clickPlace:x) (miscSlot:x);

!!if&x1=1;
  !!UN:N1/1/x2;               [получаем название заклинаниЯ на свитке в z1]
  !!SSx2:L?y1;                [получаем уровень заклинаниЯ в y1]
  *!VRy1:*15;                 [расчитываем стоимость получаемой при разрушении маны в y1 как 1*уровень заклинаниЯ]
  !!VRy1:*0;
  !!HE(CURRENT_HERO):I?y2/1;  [y2 - текущее значение маны]
  !!VRy3:Sy2 +y1;             [y3 - новое значение маны]
  !!FU(WOG_Hero_GetFullSpellPoints):P-1/?y4;  // Џолучаем y4 - максимум SP длЯ текущего героЯ
  !!VRy1&y3>y4:Sy4 -y2;       [снижаем значение получаемой маны, если мана после разрушениЯ превысит естественный максимум]
  !!VRy1&y1<0:S0;             [мана не может снижатьсЯ, даже если у героЯ сейчас запас превышает максимально возможный]
  !!SN:T^es.796.scroll^/?z2/^spell^/z1/^sp^/y1; [получаем текст вопроса в z2]
  !!IF:Q1/9/x2/2/z2;          [‚опрос: разрушить ли свиток]
  !!FU&-1:E;                  [выход, если ответ отрицательный]
  
  !!HE(CURRENT_HERO):Idy1/1;  [“становка нового значениЯ маны]
  !!VRy1:Sx2 +1001;           [в y1 номер свитка]
  !!VRy2&x3>=40:S0;           [y2=0 если слот рюкзака]
  !!VRy2&x3<40:S1;            [y2=1 если слот разного]
  !!HE(CURRENT_HERO):A3/y1/1/y2; [“даление свитка из слота]
  !!HE(CURRENT_HERO)&y2=1:A4/1080 A3/1080/1/1; [добавлЯем/удалЯем свиток с несуществующим заклинанием для обновления списка заклинаний у героя]
  !!CM:R0;                    [отмена стандартной реакции на ЏЉЊ]
  !!UN:R3/-1;                 [Ћбновление экрана героЯ]
!!en;

!!if&x1=2;
  !!SN:T^es.796.banner^/?z2;  [получаем текст вопроса в z2]
  !!IF:Q1/8/156/2/z2;         [‚опрос: подарить ли знамЯ]
  !!FU&-1:E;                  [выход, если ответ отрицательный]
  
  !!HE(CURRENT_HERO):Y65/500/3/1; [„обавление +500 очков передвижениЯ на 3 днЯ за подаренное знамя]
  !!HE(CURRENT_HERO):A3/156/1/0; [“даление знамени из слота рюкзака]
  !!CM:R0;                    [отмена стандартной реакции на ЏЉЊ]
  !!UN:R3/-1;                 [Ћбновление экрана героЯ]
!!en;

!!if&x1=3;
  !!UN:Ax2/3/?y1;             [y1 - класс артефакта (2/4/8/16)]

  !!FU&y1<2:E;                [разрушение книги/граалЯ/ЃЊ запрещено]

  *!VRy2&y1=2:S500;           [y2 - базовое кол-во опыта, получаемое в зависимости от класса артефакта (50% от опыта за пожертвование на алтаре)]
  *!VRy2&y1=4:S750;           [...]
  *!VRy2&y1=8:S1500;          [...]
  *!VRy2&y1=16:S1500;         [...]
  !!VRy2:S0;
  !!HE(CURRENT_HERO):S21/?y3; [уровень навыка "Ћбучение" героЯ]
  !!VRy3:*5 +100;             [y3 = 100/105/110/115% - коэффициент полученного опыта]
  !!VRy2:*y3 :100;            [y2 - опыт получаемый с учетом ЋбучениЯ]
  !!SN:T^es.796.art^/?z2/^exp^/y2; [получаем текст вопроса в z2]
  !!IF:Q1/8/x2/2/z2;          [Вопрос: пожертвовать ли артефакт]
  !!FU&-1:E;                  [выход, если ответ отрицательный]
  
  !!HE(CURRENT_HERO):Edy2;    [„обавление y2 очков опыта герою]
  !!HE(CURRENT_HERO):A2/x2/?y1/?y2; [‘читать кол-во x2 артефактов, y2 - надетых]
  !!HE(CURRENT_HERO):Z?y4;    [y4 - адрес памЯти структуры героЯ]

  !!if&y1>0;
    !!HE(CURRENT_HERO):A3/x2/1/0; [“даление артефакта из слота рюкзака]
  !!el&y2=0;
    !!re i/468/500/8;

      !!UN:Cy4/i/4/?y5;
      !!if&y5=x2;
        !!UN:Cy4/i/4/-1;
        !!VRy5:Si+4;
        !!UN:Cy4/y5/4/-1;
      !!en;
    !!en;
  !!en;

  !!CM:R0;                    [отмена стандартной реакции на ЏЉЊ]
  !!SN:D;                     [Ћбновление экрана героЯ]
!!en;

*?BA52&1000;                  [перед не-теоретической битвой]
*!UN:P796/?y1;                [проверяем включена ли опциЯ 796 в y1]
*!FU&y1=0:E;                  [выход если опция не включена]

*!BA:H0/?y1 H1/?y2 O?y3/?y4;  [y1,y2 - сражающиесЯ герои, y3,y4 - сражающиесЯ игроки]
*!OW:Iy3/?y5;                 [y7 - номер €€-героЯ (-1, если нет)]
*!OW&y2>=0:Iy4/?y6;           [y8 - номер героЯ-человека (-1, если нет)]
*!VRy7:S-1; 
*!VRy8:S-1;       [...]
*!VRy7&y5=1:Sy1;              [...]
*!VRy8&y5=0:Sy1;              [...]
*!VRy7&y6=1/y2>=0:Sy2;        [...]
*!VRy8&y6=0/y2>=0:Sy2;        [...]
*!FU|y7<0/y8<0:E;             [выход, если нет €€-героЯ или героЯ-человека]

*!HEy7:Ed/?y9; 
*!HEy8:Ed/?y10;               [y9/y10 - уровни героев €€/человека]
*!VRy11:Sy9 -y10;             [y11 - разница уровней героев (в пользу €€)]
*!HEy7:I?y1/1;                [y1 - мана €€-героЯ]
*!FU(WOG_Hero_GetFullSpellPoints):Py7/?y2;
*!VRy3:Sy2 *80 :100;          [y3 - 80% макс. маны €€-героЯ]
*!VRy4:Sy2 *60 :100;          [y4 - 60% макс. маны €€-героЯ]
*!VRy5:Sy2 *40 :100;          [y5 - 40% макс. маны €€-героЯ]
*!DO7930/19/82/1&y5>y1/y11<=10:P1/y7; [если маны у €€-героя меньше 40%, и он сильнее героЯ-человека не более чем на 10 уровней, уничтожаем свиток из рюкзака]
*!HEy7:I?y1/1;                [y1 - мана €€-героЯ]
*!DO7930/19/82/1&y4>y1/y11<=5:P1/y7; [если маны у €€-героя меньше 60%, и он сильнее героЯ-человека не более чем на 5 уровней, уничтожаем свиток из рюкзака]
*!HEy7:I?y1/1;                [y1 - мана €€-героЯ]
*!DO7930/19/82/1&y3>y1/y11<=0:P1/y7; [если маны у €€-героя меньше 80%, и он Ќ… сильнее героЯ-человека, уничтожаем свиток из рюкзака]

** end

